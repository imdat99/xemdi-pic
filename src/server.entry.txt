import { Hono } from 'hono'
import { serveStatic } from 'hono/bun'
import { cors } from "hono/cors";
import { RedisClient } from "bun";
import type { JwtVariables } from 'hono/jwt'
import { contextStorage } from 'hono/context-storage';
import type { HonoVarTypes } from '@/types';
import { renderToWebStream } from 'vue/server-renderer'
import { createSSRApp } from 'vue'
import App from './App.vue';
import Root from './Root.vue';
import { streamText } from 'hono/streaming';
type SessionDataTypes = {
  'counter': number
}
// import { renderer } from './renderer'
const app = new Hono<HonoVarTypes>();
// const client = new RedisClient("redis://");
// await client.connect().then(() => {
//   console.log("Connected to Redis");
// }).catch((err) => {
//   console.error("Failed to connect to Redis", err);
// });
app.use(cors(), async (c, next) => {
  c.set("fetch", app.request.bind(app));
//   c.set("redis", client);
  // c.set("acmCampaignClient", acmCampaignClient);
  await next();
}, contextStorage());

app.use(serveStatic({ root: './public' }))
// app.use(i18nHonoMiddleware, renderer)
app.get('*', async (c) => {
  const url = c.req.url;
  console.log("Request URL:", url);
  return streamText(c, async (stream) => {
    c.header("Content-Type", "text/html; charset=UTF-8")
    c.header("Content-Encoding", "Identity")
    await stream.write("<!DOCTYPE html>");
    await stream.pipe(renderToWebStream(createSSRApp(Root)));
  })
});
console.log("app running");
// app.get('/', (c) => {
//   return c.render(<h1>Hello!</h1>)
// })

export default app